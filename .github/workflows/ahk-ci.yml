name: AHK Syntax Check & Build

on:
  push:
    paths:
      - '**.ahk'
      - '**.ahk.txt'
      - '.github/workflows/ahk-ci.yml'
  pull_request:
    paths:
      - '**.ahk'
      - '**.ahk.txt'
      - '.github/workflows/ahk-ci.yml'

jobs:
  syntax-check:
    name: Syntax Validation
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Init Yunit submodule
        shell: pwsh
        run: git submodule update --init tools/Yunit

      # Download portable AHK v1 from GitHub releases (autohotkey.com is behind Cloudflare)
      - name: Install AutoHotkey v1
        shell: pwsh
        run: |
          $ahkDir = "C:\ahk-v1"
          New-Item -ItemType Directory -Path $ahkDir -Force | Out-Null
          $zipUrl = "https://github.com/AutoHotkey/AutoHotkey/releases/download/v1.1.37.02/AutoHotkey_1.1.37.02.zip"
          Invoke-WebRequest -Uri $zipUrl -OutFile "$env:TEMP\ahk-v1.zip"
          Expand-Archive -Path "$env:TEMP\ahk-v1.zip" -DestinationPath $ahkDir -Force
          # Find the exe (could be AutoHotkeyU64.exe or AutoHotkey.exe depending on zip layout)
          $exe = Get-ChildItem -Path $ahkDir -Filter "AutoHotkey*.exe" -Recurse | Select-Object -First 1
          Write-Host "AHK v1 found at: $($exe.FullName)"
          echo "AHK1_EXE=$($exe.FullName)" >> $env:GITHUB_ENV

      # Download portable AHK v2 from GitHub releases
      - name: Install AutoHotkey v2
        shell: pwsh
        run: |
          $ahkDir = "C:\ahk-v2"
          New-Item -ItemType Directory -Path $ahkDir -Force | Out-Null
          $zipUrl = "https://github.com/AutoHotkey/AutoHotkey/releases/download/v2.0.19/AutoHotkey_2.0.19.zip"
          Invoke-WebRequest -Uri $zipUrl -OutFile "$env:TEMP\ahk-v2.zip"
          Expand-Archive -Path "$env:TEMP\ahk-v2.zip" -DestinationPath $ahkDir -Force
          $exe = Get-ChildItem -Path $ahkDir -Filter "AutoHotkey*.exe" -Recurse |
            Where-Object { $_.Name -match "64" -or $_.Name -eq "AutoHotkey.exe" } |
            Select-Object -First 1
          if ($exe) {
            Write-Host "AHK v2 found at: $($exe.FullName)"
            echo "AHK2_EXE=$($exe.FullName)" >> $env:GITHUB_ENV
          } else {
            Write-Host "::warning::AHK v2 exe not found in zip"
          }

      # Syntax check v1 scripts (.ahk.txt files)
      - name: Syntax check AHK v1 scripts
        shell: pwsh
        run: |
          $ahk1 = $env:AHK1_EXE
          if (-not $ahk1 -or -not (Test-Path $ahk1)) {
            Write-Host "::error::AHK v1 exe not found at: $ahk1"
            exit 1
          }
          $failed = @()
          $scripts = Get-ChildItem -Path . -Filter "*.ahk.txt" -Recurse

          if ($scripts.Count -eq 0) {
            Write-Host "No .ahk.txt files found, skipping v1 syntax check"
            exit 0
          }

          foreach ($script in $scripts) {
            Write-Host "Checking: $($script.FullName)"

            # Copy to .ahk so AHK can parse it
            $tempAhk = "$($script.FullName -replace '\.txt$', '')"
            Copy-Item $script.FullName $tempAhk

            $proc = Start-Process -FilePath $ahk1 `
              -ArgumentList "/ErrorStdOut", "/iLib", "NUL", $tempAhk `
              -Wait -PassThru -NoNewWindow `
              -RedirectStandardError "$env:TEMP\ahk_stderr.txt" `
              -RedirectStandardOutput "$env:TEMP\ahk_stdout.txt"

            $stderr = ""
            if (Test-Path "$env:TEMP\ahk_stderr.txt") {
              $stderr = Get-Content "$env:TEMP\ahk_stderr.txt" -Raw
            }
            $stdout = ""
            if (Test-Path "$env:TEMP\ahk_stdout.txt") {
              $stdout = Get-Content "$env:TEMP\ahk_stdout.txt" -Raw
            }

            Remove-Item $tempAhk -ErrorAction SilentlyContinue

            if ($proc.ExitCode -ne 0 -or $stderr -match "Error") {
              $errMsg = if ($stderr) { $stderr } else { $stdout }
              Write-Host "::error file=$($script.Name)::Syntax error in $($script.Name): $errMsg"
              $failed += $script.Name
            } else {
              Write-Host "  PASS"
            }
          }

          if ($failed.Count -gt 0) {
            Write-Host ""
            Write-Host "::error::FAILED syntax check for: $($failed -join ', ')"
            exit 1
          }

          Write-Host ""
          Write-Host "All v1 scripts passed syntax check"

      # Syntax check v2 scripts (.ahk files with #Requires v2)
      - name: Syntax check AHK v2 scripts
        shell: pwsh
        run: |
          $ahk2 = $env:AHK2_EXE
          if (-not $ahk2 -or -not (Test-Path $ahk2)) {
            Write-Host "::warning::AHK v2 not available, skipping v2 syntax check"
            exit 0
          }

          $failed = @()
          $scripts = Get-ChildItem -Path . -Filter "*.ahk" -Recurse |
            Where-Object { $_.FullName -notmatch "\\tools\\" -and $_.FullName -notmatch "\\tests\\" }

          if ($scripts.Count -eq 0) {
            Write-Host "No standalone .ahk files found, skipping v2 syntax check"
            exit 0
          }

          foreach ($script in $scripts) {
            $firstLines = Get-Content $script.FullName -TotalCount 5
            $isV2 = $firstLines | Where-Object { $_ -match "#Requires AutoHotkey v2" }

            if (-not $isV2) {
              Write-Host "Skipping $($script.Name) (not a v2 script)"
              continue
            }

            Write-Host "Checking: $($script.FullName)"

            $proc = Start-Process -FilePath $ahk2 `
              -ArgumentList "/ErrorStdOut=utf-8", "/iLib", "NUL", $script.FullName `
              -Wait -PassThru -NoNewWindow `
              -RedirectStandardError "$env:TEMP\ahk_stderr.txt" `
              -RedirectStandardOutput "$env:TEMP\ahk_stdout.txt"

            $stderr = ""
            if (Test-Path "$env:TEMP\ahk_stderr.txt") {
              $stderr = Get-Content "$env:TEMP\ahk_stderr.txt" -Raw
            }
            $stdout = ""
            if (Test-Path "$env:TEMP\ahk_stdout.txt") {
              $stdout = Get-Content "$env:TEMP\ahk_stdout.txt" -Raw
            }

            if ($proc.ExitCode -ne 0 -or $stderr -match "Error") {
              $errMsg = if ($stderr) { $stderr } else { $stdout }
              Write-Host "::error file=$($script.Name)::Syntax error in $($script.Name): $errMsg"
              $failed += $script.Name
            } else {
              Write-Host "  PASS"
            }
          }

          if ($failed.Count -gt 0) {
            Write-Host ""
            Write-Host "::error::FAILED syntax check for: $($failed -join ', ')"
            exit 1
          }

          Write-Host ""
          Write-Host "All v2 scripts passed syntax check"

  unit-tests:
    name: Unit Tests (Yunit)
    runs-on: windows-latest
    needs: syntax-check
    steps:
      - uses: actions/checkout@v4

      - name: Init Yunit submodule
        shell: pwsh
        run: git submodule update --init tools/Yunit

      - name: Install AutoHotkey v1
        shell: pwsh
        run: |
          $ahkDir = "C:\ahk-v1"
          New-Item -ItemType Directory -Path $ahkDir -Force | Out-Null
          $zipUrl = "https://github.com/AutoHotkey/AutoHotkey/releases/download/v1.1.37.02/AutoHotkey_1.1.37.02.zip"
          Invoke-WebRequest -Uri $zipUrl -OutFile "$env:TEMP\ahk-v1.zip"
          Expand-Archive -Path "$env:TEMP\ahk-v1.zip" -DestinationPath $ahkDir -Force
          $exe = Get-ChildItem -Path $ahkDir -Filter "AutoHotkey*.exe" -Recurse | Select-Object -First 1
          echo "AHK1_EXE=$($exe.FullName)" >> $env:GITHUB_ENV

      - name: Run Yunit tests
        shell: pwsh
        run: |
          $ahk1 = $env:AHK1_EXE
          $testFiles = Get-ChildItem -Path tests -Filter "test_*.ahk.txt" -Recurse
          $failed = @()

          if ($testFiles.Count -eq 0) {
            Write-Host "No test files found in tests/, skipping"
            exit 0
          }

          foreach ($test in $testFiles) {
            Write-Host "Running: $($test.Name)"

            $tempAhk = "$($test.FullName -replace '\.txt$', '')"
            Copy-Item $test.FullName $tempAhk

            $proc = Start-Process -FilePath $ahk1 `
              -ArgumentList "/ErrorStdOut", $tempAhk `
              -Wait -PassThru -NoNewWindow `
              -RedirectStandardError "$env:TEMP\test_stderr.txt" `
              -RedirectStandardOutput "$env:TEMP\test_stdout.txt"

            $stderr = ""
            if (Test-Path "$env:TEMP\test_stderr.txt") {
              $stderr = Get-Content "$env:TEMP\test_stderr.txt" -Raw
            }
            $stdout = ""
            if (Test-Path "$env:TEMP\test_stdout.txt") {
              $stdout = Get-Content "$env:TEMP\test_stdout.txt" -Raw
            }

            Remove-Item $tempAhk -ErrorAction SilentlyContinue

            if ($stdout) { Write-Host $stdout }

            if ($proc.ExitCode -ne 0 -or $stderr -match "Error|FAIL") {
              $errMsg = if ($stderr) { $stderr } else { "Exit code: $($proc.ExitCode)" }
              Write-Host "::error file=$($test.Name)::Test failure in $($test.Name): $errMsg"
              $failed += $test.Name
            } else {
              Write-Host "  PASS"
            }
          }

          if ($failed.Count -gt 0) {
            Write-Host ""
            Write-Host "::error::FAILED tests: $($failed -join ', ')"
            exit 1
          }

          Write-Host ""
          Write-Host "All unit tests passed"

  compile-check:
    name: Compilation Check
    runs-on: windows-latest
    needs: syntax-check
    steps:
      - uses: actions/checkout@v4

      - name: Compile latest v1 script
        uses: nukdokplex/autohotkey-build@v0.1
        with:
          version: "1.1.37.02"
          x64: true
          x86: false
          compression: none
          in: .
          out: build
        continue-on-error: true

      - name: Report compilation results
        shell: pwsh
        run: |
          $exes = Get-ChildItem -Path build -Filter "*.exe" -ErrorAction SilentlyContinue
          if ($exes) {
            Write-Host "Successfully compiled:"
            foreach ($exe in $exes) {
              Write-Host "  $($exe.Name) ($([math]::Round($exe.Length / 1KB)) KB)"
            }
          } else {
            Write-Host "::warning::No executables produced. This may be expected if .ahk.txt files need renaming."
            Write-Host "Syntax validation is the primary check â€” compilation is a bonus."
          }
